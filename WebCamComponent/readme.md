# 视频录制和播放
从接入的网络摄像头（例如海康威视或者大华）录制视频并且能支持播放
## 需求说明
### 1、连接摄像头
登录，预览视频，可以设置预览的参数如：视频分辨率（宽、高）、帧率，在ImageView上播放视频帧。
### 2、录制视频
（1）调用方传递存储视频文件的文件夹目录，在此目录下建立video_monitor文件夹，将录制的视频存储在video_monitor文件夹中
（2）分段录制，默认5分钟一段，可通过参数设置录制时长
（3）存储文件名字dvr_0001.mp4/dvr_001.avi，格式mp4 或者avi
### 3、播放
传参指定显示某一秒的视频帧，将分段视频放在一起播放，并且可以任意指定到某个位置播放

## 实现方案
### 1、初始化
配置ParameterConfig配置IP地址、端口、用户名、密码、分辨率、帧率、文件夹地址
### 2、视频预览
（1）将ImageView作为参数传进来，视频预览，
（2）功能：开始录制、暂停录制，视频分段存储，使用JavaCV 进行存储
（3）退出，释放资源
### 3、播放视频
（1）自定义控件VideoFrameDisplay 视频帧展示，接受时间（秒）参数，播放此时间的视频帧

### 4、获取指定时间的视频帧
传入参数time（第几秒的视频），filePath（视频所在文件夹路径）
1、计算文件夹下所有视频文件的信息，包括视频时长，文件File
2、根据文件序号排序
3、根据每个视频文件的视频时长，不断累加，并且与传入的时长比较，找到时长所在的视频文件
4、传入时长减去累计的视频时长，得到所在视频的第几秒的视频帧
5、根据计算到的时长，找到视频帧，返回视频帧的Image
### 5、播放多段视频
1、传入参数dirPath： 存放视频的文件夹路径，MediaView ：播放视频的控件，
2、公共方法，播放play（），转到某播放处seekTo（long），暂停puse（）
3、回调，类名SegmentVideoPlayCallback，方法onProgress(int,int)

## 准备工作
1、了解海康威视网络摄像头功能API ,将Demo 运行起来
2、了解JavaFx 自定义控件功能

## 工作日志
2023年7月5日，了解需求，编写需求项以及实现方案
2023年7月6日，对接摄像头，获取视频帧
2023年7月7日，编写控制、播放视频帧的功能
2023年7月10日，优化视频卡顿的问题，编写视频录制的功
2023年7月11日，使用非阻塞取流，解决视频卡顿的问题，找到视频掉帧的原因：摄像头返回的帧率与我们设置录制视频的帧率不同，
2023年7月12日，优化配置，根据传入的视频分辨率和帧率，找到跟摄像头分辨率和帧率相同或者相近的配置参数，并设置该参数到摄像头
2023年7月13日，完成编写根据时间取视频帧的功能，编写部分播放视频的功能
2023年7月14日，完善视频播放的功能，遇到分段视频不能播放的问题
2023年7月17日，完善视频播放的功能，解决分段视频不能播放的问题，并且优化播放进度控制功能，解决不能准确指定到播放位置的问题



## 遇到的问题
1、在Intellij Idea 上建立JavaFx工程 将海康威视的Java Demo代码和依赖库复制到过来，编译运行出现错误：
Unable to make public abstract void com.NetSDKDemo.HCNetSDK$FExceptionCallBack.invoke(int,int,int,com.sun.jna.Pointer) accessible: module com.fs.webcamcomponent does not "exports com.NetSDKDemo" to module jna

解决方式：在工程的module-info.java 文件添加
opens com.NetSDKDemo to jna;
    exports com.NetSDKDemo;
    
2、视频录制掉帧，原因；摄像头返回的帧率与我们设置录制视频的帧率不同。
解决方式：视频录制的帧率要与摄像头返回的视频流的帧率一致。

3、播放视频时，由于文件问含有特殊字符[],java 无法识别
解决方式：使用URLEncoder.encode()对文件名进行转码

4、分段录制的视频，除了第一个视频，其他的不能正常播放
解决方式：在录制视频时FFmpegFrameRecorder，增加设置参数setOption("reset_timestamps","1");

5、MediaPlay 调用seek 无效
解决方式：设置setOnReady（）在回调中调用seek。